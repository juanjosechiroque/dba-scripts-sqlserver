
DECLARE @BASEDATOS varchar(50)
DECLARE @CARPETA varchar(50) 
DECLARE @ARCHIVOBACKUP VARCHAR (100)
DECLARE @NOMBREBACKUP VARCHAR(100)
DECLARE @FECHA DATETIME

SET @CARPETA = N'D:\BACKUPDB'

DECLARE DATABASES_CURSOR CURSOR FOR 

	SELECT 
			NAME 
	FROM 
			SYS.DATABASES 
	WHERE 
			NAME NOT IN ('MASTER', 'TEMPDB', 'MODEL', 'MSDB')

OPEN DATABASES_CURSOR

FETCH NEXT FROM DATABASES_CURSOR INTO @BASEDATOS

WHILE @@FETCH_STATUS = 0
BEGIN  
	
	SET @FECHA = GETDATE()
	
	SET @NOMBREBACKUP = @BaseDatos + N'_'
	+ STR(DATEPART(YEAR, @FECHA), 4, 0)
	+ REPLACE(STR(DATEPART(MONTH, @FECHA), 2, 0), N' ', N'0')
	+ REPLACE(STR(DATEPART(DAY, @FECHA), 2, 0), N' ', N'0')
	+ REPLACE(STR(DATEPART(HOUR, @FECHA), 2, 0), N' ', N'0')
	+ REPLACE(STR(DATEPART(MINUTE, @FECHA), 2, 0), N' ', N'0')	
	
	SET @ARCHIVOBACKUP = @CARPETA + N'\'' + @NOMBREBACKUP + N'.bak'

	BACKUP DATABASE @BASEDATOS
	TO DISK = @ARCHIVOBACKUP
	WITH NOFORMAT,
	INIT,
	SKIP,
	NAME = @NOMBREBACKUP

    FETCH NEXT FROM DATABASES_CURSOR INTO @BASEDATOS

END

CLOSE DATABASES_CURSOR
DEALLOCATE DATABASES_CURSOR
